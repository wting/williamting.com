Author: William Ting
Date: 2012-07-01
Title: Autotools Tutorial
Tags: c, c++, autotools, automake, autoconf, gnome
Status: draft

In the past I've always handcrafted my own Makefiles. However, GNOME uses GNU
Autotools (Autoconf, Automake, Libtools) to build and install the program.
Automake is merely one piece of the toolchain, responsible for converting a
Makefile.am into a usable Makefile. These tools present end users with the
familiar `./configure && make && make install` build process.

![autoconf flowchart](/images/autoconf-process.png)

*- source [Wikipedia][diagram]*

### make and configure

Put simply, the `make` tool uses the *Makefile* file in a project directory to
build certain targets, which may involve compiling, linking, and resolving
dependencies. Writing Makefiles is fairly straightforward, but more info can be
found in the [manual][make-man].

On the other hand, `configure` scripts are used to enable cross-platform
compiling. It interprets a *Makefile.in* file and then creates a
platform-specific *Makefile*.

### autoconf

Let's assume the following project structure:

    src/
    hello.c
    doc/
    man/
    tests/
    AUTHORS
    ChangeLog
    LICENSE
    README

1. Move existing Makefiles.

        $ mv Makefile Makefile.bak

2. Generate *configure.ac*.

        $ autoscan

    `autoscan` creates *configure.scan* by performing a quick analysis on the
    file structures. Rename the created file.

        $ mv configure.scan configure.ac

3. Edit *configure.ac* and add / modify these lines.

        AC_INIT([hello_world], [1.0], [bug-report@hw.com])

    [AC_INIT][ac_init] initializes `autoconf` with project information.

        AC_CONFIG_HEADERS([config.h])

    [AC_CONFIG_HEADERS][ac_config_headers] adds list of files to be generated by configure.

        AC_PROG_CC
        AC_PROG_CXX

    Only one of the above should be used, determines which compilers should be
    used. Use [AC_PROG_CC][ac_prog_cc] for C programs, and
    [AC_PROG_CXX][ac_prog_cxx] for C++.


4. Generate *configure*.

        $ autoconf

    This generates `autom4te.cache/` and `configure`. The first directory being
    a cache folder for autoconf tools and the latter script for end users.

### automake

`automake` looks for a file called *Makefile.am* to then create *Makefile.in*.
This is later used by `configure`.

1. Create *Makefile.am*.

        $ vim Makefile.am

2. Add a couple `automake` options.

        AUTOMAKE_OPTIONS = foreign
        SUBDIRS = src

    `SUBDIRS` tells `automake` which directories to go further process.

    If the project is a single flat directory, there is no need for `SUBDIRS`.

> **Side Note**
>
> `Automake` expects a GNU-style project with files like *NEWS* *README*
> *AUTHORS* *ChangeLog*. You can fix this through one of the following ways:
>
>     $ touch NEWS README AUTHORS COPYING ChangeLog
>
> or add the following option to your *Makefile.am*:
>
>     AUTOMAKE_OPTIONS = foreign

3. Modify *src/Makefile.am* (or the original *./Makefile.am* if a single
directory structure) and add compiler and linker options:

        AM_CFLAGS = -Wall --pedantic -std=c99 -O2
        AM_LDFLAGS =

4. Add these lines to name your program and list the source files:

        bin_PROGRAMS = hello
        hello_SOURCES = hello.h hello.c main.c

[diagram]: https://en.wikipedia.org/wiki/File:Autoconf-automake-process.svg
[make-man]: https://www.gnu.org/software/make/manual/make.html#Makefiles

[ac_init]: http://www.gnu.org/software/autoconf/manual/html_node/Initializing-configure.html
[ac_init_automake]: http://www.gnu.org/software/automake/manual/html_node/Public-Macros.html#index-AM_005fINIT_005fAUTOMAKE-284
[ac_config_headers]: http://www.gnu.org/software/autoconf/manual/html_node/Configuration-Files.html
[ac_prog_cc]: http://www.gnu.org/software/autoconf/manual/html_node/C-Compiler.html#index-AC_005fPROG_005fCC-842
[ac_prog_cxx]: http://www.gnu.org/software/autoconf/manual/html_node/C_002b_002b-Compiler.html#index-AC_005fPROG_005fCXX-914
